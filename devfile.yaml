schemaVersion: 2.2.0
metadata:
  name: polling-app
attributes:
  controller.devfile.io/bootstrap-devworkspace: true
  controller.devfile.io/storage-type: per-workspace

projects:
  - git:
      remotes:
        origin: https://github.com/SmallCloudCo/polling-app.git
    name: polling-app

components:
  - name: universal-developer-image
    container:
      image: quay.io/devfile/universal-developer-image:ubi8-d071837
      sourceMapping: /projects
      memoryRequest: 512Mi
      memoryLimit: 2Gi
      cpuRequest: 100m
      cpuLimit: 1000m
      env:
        - name: GIT_AUTHOR_NAME
          value: "Luis Gonzalez"
        - name: GIT_AUTHOR_EMAIL
          value: "decaturdev@gmail.com"
        - name: GIT_COMMITTER_NAME
          value: "Luis Gonzalez"
        - name: GIT_COMMITTER_EMAIL
          value: "decaturdev@gmail.com"

  - name: prep-workspace
    container:
      args:
        - '-c'
        - >-
          mkdir -p /projects/bin && cp /usr/bin/oc /projects/bin/oc && cp /usr/bin/kubectl /projects/bin/kubectl && if [[ -f ${HOME}/.kube/config ]]; then rm ${HOME}/.kube/config; fi
      command:
        - /bin/bash
      image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
      mountSources: true
      sourceMapping: /projects
      memoryRequest: 128Mi
      memoryLimit: 256Mi
      cpuRequest: 10m
      cpuLimit: 200m
      env:
        - name: HOME
          value: "/projects/home"

  - name: vscode-openshift
    plugin:
      id: redhat/vscode-openshift-connector/latest
      preferences:
        "openshiftToolkit.showChannelOnStart": true
        "openshiftToolkit.autocheck": true

commands:
  - id: prep-workspace
    apply:
      component: prep-workspace
      label: Copy OpenShift CLI

  - id: setup-extensions
    exec:
      component: universal-developer-image
      commandLine: |
        code --install-extension redhat.vscode-openshift-connector
      workingDir: ${PROJECT_SOURCE}
      group:
        kind: build
        isDefault: true

events:
  preStart:
    - prep-workspace